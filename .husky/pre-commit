#!/bin/sh
# Pre-commit hook: .env 파일 커밋 방지 + 보안 검사
#
# 설치: cp .husky/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# 색상 정의
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 1. .env 파일 커밋 차단
if git diff --cached --name-only | grep -E "\.env($|\.)" ; then
  echo "${RED}❌ BLOCKED:${NC} .env 파일은 커밋할 수 없습니다."
  echo "   이 파일들을 스테이지에서 제거하세요: git reset HEAD <file>"
  exit 1
fi

# 2. 하드코딩된 시크릿 패턴 검사
SECRETS_PATTERN="(API_KEY|SECRET|PASSWORD|TOKEN|PRIVATE_KEY)\s*=\s*['\"][^'\"]+['\"]"
if git diff --cached -U0 | grep -E "$SECRETS_PATTERN" | grep -v "process.env" | grep -v "// " ; then
  echo "${YELLOW}⚠️  WARNING:${NC} 하드코딩된 시크릿이 감지되었습니다."
  echo "   환경변수를 사용하세요: process.env.YOUR_SECRET"
  read -p "계속 진행하시겠습니까? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# 3. AWS 키 패턴 검사
AWS_PATTERN="(AKIA|ABIA|ACCA|ASIA)[0-9A-Z]{16}"
if git diff --cached | grep -E "$AWS_PATTERN" ; then
  echo "${RED}❌ BLOCKED:${NC} AWS Access Key가 감지되었습니다."
  exit 1
fi

# 모든 검사 통과
exit 0
